name: Migration from Azure DevOps

on:
  workflow_dispatch:
    inputs:
      source-repository:
        description: Git url for the repo being migrated. e.g. https://racwa@dev.azure.com/racwa/MRP/_git/VehiclesApi
        required: true
      dry-run:
        description: Enables dry run which will disable any pushes and make no changes
        required: true
        type: boolean
    
jobs:
  clone-and-merge: # This job is run manually
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' # We only want this job running from manual actions
    steps:
      - run: |
          echo "TARGET_GIT_URL=$GITHUB_SERVER_URL/$GITHUB_REPOSITORY" >> $GITHUB_ENV
          
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          path: target
          
      - name: Check branch does not exist
        working-directory: target
        run: |
          migrationExists=$(git ls-remote --heads origin migration)
          
          if [[ -z "$migrationExists" ]]; then
              echo 'Migration branch does not exist. Continuing'
          else
              echo "::error::Migration branch already exists. Please delete this branch and run the workflow again"
              exit 1
          fi
          
      - run: |
      
          # $B64Pat= echo -n ${{secrets.AZURE_DEVOPS_MIGRATION_PAT}} | base64
          
          git --version
          
          git lfs --version
          
          #git config --global http.version HTTP/1.1
          git config --global --add http.https://bertington@dev.azure.com.extraHeader "AUTHORIZATION: bearer cnBqczVncXF6eDV0NnlyNmw2dTdya3pkeWlrM2FzbHJnY2Y2ZjZ1cnB2eXgzNmVoZG53cQ=="
          # git clone -c http.extraHeader="AUTHORIZATION: basic cnBqczVncXF6eDV0NnlyNmw2dTdya3pkeWlrM2FzbHJnY2Y2ZjZ1cnB2eXgzNmVoZG53cQ==" --mirror ${{ inputs.source-repository }} source
          
          echo "Cloning repo..."
          git clone --mirror ${{ inputs.source-repository }} source
          
          cd source
          
          echo "Fetching lfs shit"
          git lfs fetch --all
          
          echo "Fetching tags"
          git fetch --all --tags
        
      - name: Merge source into target
        working-directory: target
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "<>"
          
          git remote add source ../source --fetch --tags
          git checkout -b migration
          git merge source/main --allow-unrelated-histories -X theirs
          git lfs fetch source --all
                    
          git remote remove source
          
          echo "### LFS Filters:" >> $GITHUB_STEP_SUMMARY
          git lfs track >> $GITHUB_STEP_SUMMARY
          
          echo "### Tracked Files:" >> $GITHUB_STEP_SUMMARY
          git lfs ls-files --all >> $GITHUB_STEP_SUMMARY
        
      - name: Print Diagram
        working-directory: target
        run: |
          echo "### Git Log:" >> $GITHUB_STEP_SUMMARY
          git log --all --decorate --oneline --graph --date=short --pretty="%ad - %s" >> $GITHUB_STEP_SUMMARY
    
      - name: Push Migration Changes
        working-directory: target
        if: ${{ !inputs.dry-run }}
        run: |
          git push --follow-tags --set-upstream origin migration
          
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v4
        with:
          title: 'DevOps Migration from ${{inputs.source-repository}}'
          path: target
